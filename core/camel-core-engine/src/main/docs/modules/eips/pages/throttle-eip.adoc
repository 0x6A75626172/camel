= Throttle EIP
:doctitle: Throttle
:shortname: throttle
:description: Controls the rate at which messages are passed to the next node in the route
:since: 
:supportlevel: Stable

How can I throttle messages to ensure that a specific endpoint does not get overloaded, or we donâ€™t exceed an agreed SLA with some external service?

image::eip/MessagingAdapterIcon.gif[image]

Use a Throttler that controls the rate how many or fast messages are flowing to the endpoint.

== Options

// eip options: START
include::partial$eip-options.adoc[]
// eip options: END

== Using Throttle

The below example will throttle messages all messages received on seda:a before being sent to mock:result
ensuring that a maximum of 3 messages are sent during a running 10-seconds window slot.

[source,java]
----
from("seda:a")
  .throttle(3).timePeriodMillis(10000)
  .to("mock:result");
----

To use 10-seconds window we set the `timePeriodMillis` to ten-thousand. The default value is 1000 (i.e. 1 second),
meaning that setting just `throttle(3)` has the effect of setting the maximum number of requests per second.

To throttle by 50 requests per second, would look like this:

[source,java]
----
from("seda:a")
  .throttle(50)
  .to("seda:b");
----

And the examples in XML:

[source,xml]
----
<route>
  <from uri="seda:a"/>
  <throttle timePeriodMillis="10000">
    <constant>3</constant>
  </throttle>
  <to uri="mock:result"/>
</route>
----

And to throttle 50 message per second:

[source,xml]
----
<route>
  <from uri="seda:a"/>
  <throttle>
    <constant>50</constant>
  </throttle>
  <to uri="mock:result"/>
</route>
----

=== Dynamically changing maximum requests per period

TODO: 

Since we use an Expression you can adjust this value at runtime, for example you can provide a header with the value. At runtime Camel evaluates the expression and converts the result to a `java.lang.Long` type. In the example below we use a header from the message to determine the maximum requests per period. If the header is absent, then the Throttler uses the old value. So that allows you to only provide a header if the value is to be changed:

[source,xml]
----
<route>
  <from uri="direct:expressionHeader"/>
  <throttle timePeriodMillis="500">
    <!-- use a header to determine how many messages to throttle per 0.5 sec -->
    <header>throttleValue</header>
  </throttle>
  <to uri="log:result"/>
  <to uri="mock:result"/>
</route>
----

=== Asynchronous delaying

You can let the Throttler use non-blocking asynchronous delaying,
which means Camel will use a scheduler to schedule a task to be executed in the future.
The task will then continue routing. This allows the caller thread to not block and be able to service other messages, etc.

In Java DSL you enable asynchronous delaying using `asyncDelayed` as shown:

[source,java]
---------------------
from("seda:a")
  .throttle(100).asyncDelayed()
  .to("seda:b");
---------------------

And in XML:

[source,xml]
----
<route>
  <from uri="seda:a"/>
  <throttle timePeriodMillis="100" asyncDelayed="true">
    <constant>100</constant>
  </throttle>
  <to uri="seda:b"/>
</route>
----